<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ä¹æ’­æ”¾å™¨ - éœ“è™¹ç‰¹æ•ˆç‰ˆ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Favicon é…ç½® -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="favicon.ico">
    <link rel="icon" sizes="32x32" href="favicon.ico">
    <link rel="icon" sizes="16x16" href="favicon.ico">
    
    <style>
        :root {
            --font-main: 'Orbitron', 'Noto Sans SC', 'Segoe UI', Arial, sans-serif;
            --neon-primary: #00ffff;
            --neon-secondary: #ff00ff;
            --neon-accent: #ffff00;
            --neon-green: #39ff14;
            --bg-dark: #0a0a0f;
            --bg-card: rgba(15, 15, 25, 0.8);
            --bg-glass: rgba(255, 255, 255, 0.05);
            --text-primary: #ffffff;
            --text-secondary: #b8b8ff;
            --text-accent: var(--neon-primary);
            --shadow-neon: 0 0 20px var(--neon-primary), 0 0 40px var(--neon-primary), 0 0 60px var(--neon-primary);
            --shadow-card: 0 8px 32px rgba(0, 255, 255, 0.1);
            --border-neon: 1px solid var(--neon-primary);
        }

        .dark-mode {
            --neon-primary: #ff6b35;
            --neon-secondary: #f7931e;
            --neon-accent: #ffff00;
            --bg-dark: #1a0a0a;
            --bg-card: rgba(25, 5, 5, 0.8);
            --text-accent: var(--neon-primary);
            --shadow-neon: 0 0 20px var(--neon-primary), 0 0 40px var(--neon-primary), 0 0 60px var(--neon-primary);
            --shadow-card: 0 8px 32px rgba(255, 107, 53, 0.1);
            --border-neon: 1px solid var(--neon-primary);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* åŠ¨æ€èƒŒæ™¯ç²’å­æ•ˆæœ */
        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 20% 80%, var(--neon-primary) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, var(--neon-secondary) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, var(--neon-accent) 0%, transparent 50%),
                linear-gradient(45deg, var(--bg-dark), #1a1a2e);
            animation: backgroundPulse 8s ease-in-out infinite;
        }

        @keyframes backgroundPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* æµ®åŠ¨å‡ ä½•å›¾å½¢ */
        .floating-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .shape {
            position: absolute;
            color: var(--neon-primary);
            font-size: 1.5rem;
            animation: float 6s ease-in-out infinite;
            opacity: 0.3;
        }

        .shape:nth-child(odd) {
            color: var(--neon-secondary);
            animation-duration: 8s;
        }

        .shape:nth-child(3n) {
            color: var(--neon-green);
            animation-duration: 7s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-20px) rotate(90deg); }
            50% { transform: translateY(-40px) rotate(180deg); }
            75% { transform: translateY(-20px) rotate(270deg); }
        }

        /* ä¸»å®¹å™¨ */
        .app-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: var(--border-neon);
            border-radius: 24px;
            padding: 35px;
            width: 100%;
            max-width: 900px;
            box-shadow: var(--shadow-card);
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--neon-primary), var(--neon-secondary), var(--neon-accent), var(--neon-primary));
            border-radius: 26px;
            z-index: -1;
            animation: neonBorder 3s linear infinite;
        }

        @keyframes neonBorder {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* æ ‡é¢˜åŒºåŸŸ */
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(45deg, var(--neon-primary), var(--neon-secondary), var(--neon-accent));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: neonText 2s ease-in-out infinite alternate;
            text-shadow: var(--shadow-neon);
            letter-spacing: 2px;
        }

        @keyframes neonText {
            0% { 
                background-position: 0% 50%;
                filter: hue-rotate(0deg);
            }
            100% { 
                background-position: 100% 50%;
                filter: hue-rotate(45deg);
            }
        }

        .header .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-top: 10px;
            opacity: 0.8;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: var(--bg-glass);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .card:hover::before {
            left: 100%;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px rgba(0, 255, 255, 0.2);
            border-color: var(--neon-primary);
        }

        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .file-upload-card {
            border: 2px dashed var(--neon-primary);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-card:hover {
            border-color: var(--neon-secondary);
            background: rgba(0, 255, 255, 0.05);
            box-shadow: var(--shadow-neon);
        }

        .file-upload-icon {
            font-size: 3rem;
            color: var(--neon-primary);
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .playlist-card, .lyrics-card {
            height: 350px;
            overflow-y: auto;
        }

        /* æ’­æ”¾åˆ—è¡¨æ ·å¼ */
        .playlist-item {
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            position: relative;
        }

        .playlist-item:hover {
            background: linear-gradient(45deg, rgba(0, 255, 255, 0.1), rgba(255, 0, 255, 0.1));
            border-color: var(--neon-primary);
            transform: translateX(10px);
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.3);
        }

        .playlist-item.current {
            background: linear-gradient(45deg, var(--neon-primary), var(--neon-secondary));
            color: var(--bg-dark);
            font-weight: bold;
            box-shadow: var(--shadow-neon);
            animation: currentTrack 2s ease-in-out infinite alternate;
        }

        @keyframes currentTrack {
            0% { box-shadow: 0 0 20px var(--neon-primary); }
            100% { box-shadow: 0 0 30px var(--neon-secondary); }
        }

        /* æ­Œè¯æ ·å¼ */
        .lyrics-line {
            padding: 8px 0;
            transition: all 0.5s ease;
            text-align: center;
            line-height: 1.8;
        }

        .lyrics-line.current {
            color: var(--neon-accent);
            font-weight: bold;
            transform: scale(1.1);
            text-shadow: 0 0 20px var(--neon-accent);
            background: linear-gradient(45deg, rgba(255, 255, 0, 0.1), rgba(0, 255, 255, 0.1));
            border-radius: 8px;
            margin: 5px 0;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .control-btn {
            background: linear-gradient(45deg, var(--neon-primary), var(--neon-secondary));
            color: var(--bg-dark);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-card);
            position: relative;
            overflow: hidden;
        }

        .control-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }

        .control-btn:hover::before {
            width: 100%;
            height: 100%;
        }

        .control-btn:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: var(--shadow-neon);
        }

        .special-btn {
            width: auto;
            padding: 0 25px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: bold;
        }

        /* éŸ³é¢‘æ’­æ”¾å™¨æ ·å¼ */
        .audio-player {
            flex: 1;
            min-width: 300px;
            background: var(--bg-glass);
            border: 1px solid var(--neon-primary);
            border-radius: 25px;
            padding: 10px;
        }

        /* ä¸»é¢˜åˆ‡æ¢ */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 30px;
            background: var(--bg-glass);
            border: var(--border-neon);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle-ball {
            width: 24px;
            height: 24px;
            background: linear-gradient(45deg, var(--neon-primary), var(--neon-secondary));
            border-radius: 50%;
            margin: 3px;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px var(--neon-primary);
        }

        .theme-toggle.active .theme-toggle-ball {
            transform: translateX(30px);
            background: linear-gradient(45deg, var(--neon-secondary), var(--neon-accent));
        }

        /* ç§»åŠ¨ç«¯è§†å›¾åˆ‡æ¢ */
        .view-toggle {
            display: none;
            gap: 10px;
            margin: 20px 0;
        }

        .view-btn {
            flex: 1;
            padding: 12px;
            background: var(--bg-glass);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background: linear-gradient(45deg, var(--neon-primary), var(--neon-secondary));
            color: var(--bg-dark);
            font-weight: bold;
            box-shadow: var(--shadow-card);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loader {
            width: 30px;
            height: 30px;
            border: 3px solid transparent;
            border-top: 3px solid var(--neon-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-glass);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--neon-primary), var(--neon-secondary));
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, var(--neon-secondary), var(--neon-accent));
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
            }

            .container {
                padding: 20px;
                border-radius: 16px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .main-content {
                grid-template-columns: 1fr;
            }

            .view-toggle {
                display: flex;
            }

            .playlist-card, .lyrics-card {
                height: 300px;
            }

            .mobile-hidden {
                display: none !important;
            }

            .controls {
                gap: 10px;
            }

            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .audio-player {
                order: -1;
                width: 100%;
                min-width: unset;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- åŠ¨æ€èƒŒæ™¯ -->
    <div class="background-animation"></div>
    
    <!-- æµ®åŠ¨å‡ ä½•å½¢çŠ¶ -->
    <div class="floating-shapes">
        <div class="shape" style="top: 10%; left: 10%; animation-delay: 0s;">â–³</div>
        <div class="shape" style="top: 20%; right: 15%; animation-delay: 1s;">â—†</div>
        <div class="shape" style="bottom: 30%; left: 20%; animation-delay: 2s;">â–²</div>
        <div class="shape" style="top: 60%; right: 25%; animation-delay: 3s;">â—</div>
        <div class="shape" style="bottom: 20%; right: 10%; animation-delay: 4s;">â– </div>
        <div class="shape" style="top: 80%; left: 60%; animation-delay: 5s;">â—‡</div>
    </div>

    <div class="app-container">
        <div class="container">
            <!-- ä¸»é¢˜åˆ‡æ¢ -->
            <div class="theme-toggle" id="themeToggle">
                <div class="theme-toggle-ball"></div>
            </div>

            <!-- æ ‡é¢˜åŒºåŸŸ -->
            <div class="header">
                <h1>ğŸµ NEON PLAYER</h1>
                <div class="subtitle">éœ“è™¹éŸ³ä¹æ’­æ”¾å™¨ - ä½“éªŒæœªæ¥éŸ³ä¹</div>
            </div>

            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="card file-upload-card" id="fileDropArea">
                <input type="file" id="fileInput" multiple accept="audio/*,.lrc,.txt" style="display: none;">
                <label for="fileInput" style="cursor: pointer;">
                    <div class="file-upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div>ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ”¾éŸ³ä¹æ–‡ä»¶</div>
                    <div style="font-size: 0.9rem; opacity: 0.7; margin-top: 10px;">
                        æ”¯æŒ MP3, WAV, FLAC ç­‰æ ¼å¼
                    </div>
                </label>
            </div>

            <!-- ç§»åŠ¨ç«¯è§†å›¾åˆ‡æ¢ -->
            <div class="view-toggle">
                <button class="view-btn active" id="showPlaylistBtn">
                    <i class="fas fa-list"></i> æ’­æ”¾åˆ—è¡¨
                </button>
                <button class="view-btn" id="showLyricsBtn">
                    <i class="fas fa-music"></i> æ­Œè¯
                </button>
            </div>

            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <div class="main-content">
                <div class="card playlist-card">
                    <h3 style="margin-bottom: 15px; color: var(--neon-primary);">
                        <i class="fas fa-headphones"></i> æ’­æ”¾åˆ—è¡¨
                    </h3>
                    <div id="playlist">
                        <div style="text-align: center; opacity: 0.6; padding: 40px 0;">
                            é€‰æ‹©éŸ³ä¹æ–‡ä»¶æˆ–æ¢ç´¢åœ¨çº¿éŸ³ä¹
                        </div>
                    </div>
                </div>

                <div class="card lyrics-card mobile-hidden">
                    <h3 style="margin-bottom: 15px; color: var(--neon-secondary);">
                        <i class="fas fa-quote-left"></i> æ­Œè¯æ˜¾ç¤º
                    </h3>
                    <div id="lyrics">
                        <div class="lyrics-line" style="opacity: 0.6;">
                            æ­Œè¯å°†åœ¨æ­¤å¤„åŒæ­¥æ˜¾ç¤º...
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶åŒºåŸŸ -->
            <div class="controls">
                <button class="control-btn" onclick="playPrevious()" title="ä¸Šä¸€æ›²">
                    <i class="fas fa-step-backward"></i>
                </button>
                
                <audio class="audio-player" id="audioPlayer" controls></audio>
                
                <button class="control-btn" onclick="playNext()" title="ä¸‹ä¸€æ›²">
                    <i class="fas fa-step-forward"></i>
                </button>
                
                <button class="control-btn special-btn" id="loadOnlineBtn" title="æ¢ç´¢åœ¨çº¿éŸ³ä¹">
                    <span class="btn-text">
                        <i class="fas fa-satellite-dish"></i> æ¢ç´¢é›·è¾¾
                    </span>
                    <span class="loader" style="display: none;"></span>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.7/jsmediatags.min.js"></script>
    <script>
        const dom = {
            playlist: document.getElementById('playlist'),
            lyrics: document.getElementById('lyrics'),
            audioPlayer: document.getElementById('audioPlayer'),
            themeToggle: document.getElementById('themeToggle'),
            loadOnlineBtn: document.getElementById('loadOnlineBtn'),
            fileInput: document.getElementById('fileInput'),
            fileDropArea: document.getElementById('fileDropArea'),
            showPlaylistBtn: document.getElementById('showPlaylistBtn'),
            showLyricsBtn: document.getElementById('showLyricsBtn'),
        };
        
        const API = {
            name: 'GD Studio API',
            baseUrl: 'https://music-api.gdstudio.xyz/api.php',
            getList: async () => {
                const keyword = 'çƒ­é—¨'; 
                const url = `${API.baseUrl}?types=search&source=netease,kuwo&name=${encodeURIComponent(keyword)}&count=100`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                if (!Array.isArray(data) || data.length === 0) throw new Error('No songs found');
                return data.map(song => ({
                    id: song.id,
                    name: song.name,
                    artists: [{ name: song.artist.join(' / ') }],
                    source: song.source,
                    lyric_id: song.lyric_id,
                }));
            },
            getSongUrl: (song) => `${API.baseUrl}?types=url&id=${song.id}&source=${song.source || 'netease'}&br=320000`,
            getLyric: (song) => `${API.baseUrl}?types=lyric&id=${song.lyric_id || song.id}&source=${song.source || 'netease'}`,
        };

        const state = {
            isOnlineMode: false,
            audioFiles: [],
            lyricsFiles: {},
            onlineSongs: [],
            currentTrackIndex: -1,
            currentAudioUrl: null,
            lyricsData: [],
            currentLyricLine: -1,
        };

        // åˆå§‹åŒ–
        window.addEventListener('load', setupInteractions);
        dom.audioPlayer.addEventListener('ended', autoPlayNext);
        dom.audioPlayer.addEventListener('timeupdate', syncLyrics);

        function setupInteractions() {
            // ä¸»é¢˜åˆ‡æ¢
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                dom.themeToggle.classList.add('active');
            }

            dom.themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                dom.themeToggle.classList.toggle('active');
                const isDark = document.body.classList.contains('dark-mode');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });

            // æ–‡ä»¶å¤„ç†
            dom.loadOnlineBtn.addEventListener('click', exploreOnlineMusic);
            dom.fileInput.addEventListener('change', (e) => processFiles(e.target.files));
            dom.fileDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dom.fileDropArea.style.borderColor = 'var(--neon-secondary)';
            });
            dom.fileDropArea.addEventListener('dragleave', (e) => {
                dom.fileDropArea.style.borderColor = 'var(--neon-primary)';
            });
            dom.fileDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dom.fileDropArea.style.borderColor = 'var(--neon-primary)';
                processFiles(e.dataTransfer.files);
            });
            
            // ç§»åŠ¨ç«¯è§†å›¾åˆ‡æ¢
            dom.showPlaylistBtn.addEventListener('click', () => switchMobileView('playlist'));
            dom.showLyricsBtn.addEventListener('click', () => switchMobileView('lyrics'));

            // åˆ›å»ºæ›´å¤šæµ®åŠ¨å›¾å½¢
            createFloatingShapes();
        }

        function createFloatingShapes() {
            const shapes = ['â–³', 'â—†', 'â–²', 'â—', 'â– ', 'â—‡', 'â–¼', 'â—€', 'â–¶', 'â™¦'];
            const container = document.querySelector('.floating-shapes');
            
            for (let i = 0; i < 15; i++) {
                const shape = document.createElement('div');
                shape.className = 'shape';
                shape.textContent = shapes[Math.floor(Math.random() * shapes.length)];
                shape.style.left = Math.random() * 100 + '%';
                shape.style.top = Math.random() * 100 + '%';
                shape.style.animationDelay = Math.random() * 5 + 's';
                shape.style.fontSize = (Math.random() * 1.5 + 0.8) + 'rem';
                container.appendChild(shape);
            }
        }

        async function exploreOnlineMusic() {
            state.isOnlineMode = true;
            if (window.innerWidth <= 768) switchMobileView('playlist');

            const btnText = dom.loadOnlineBtn.querySelector('.btn-text');
            const loader = dom.loadOnlineBtn.querySelector('.loader');
            
            dom.loadOnlineBtn.disabled = true;
            btnText.style.display = 'none';
            loader.style.display = 'inline-block';
            dom.playlist.innerHTML = `<div style="text-align: center; padding: 20px;"><i class="fas fa-satellite-dish"></i> æ­£åœ¨èšåˆé›·è¾¾æ­Œå•...</div>`;
            
            try {
                const songs = await API.getList();
                shuffleArray(songs);
                state.onlineSongs = songs;
                renderOnlinePlaylist();
                if (state.onlineSongs.length > 0) findAndPlayOnlineSong(0);
            } catch (error) {
                console.error("åŠ è½½åœ¨çº¿æ­Œæ›²æ—¶å‘ç”Ÿé”™è¯¯:", error);
                dom.playlist.innerHTML = "<div style='text-align: center; color: var(--neon-secondary); padding: 20px;'>åŠ è½½å¤±è´¥ï¼ŒAPIæºä¸å¯ç”¨</div>";
            } finally {
                dom.loadOnlineBtn.disabled = false;
                btnText.style.display = 'inline-block';
                loader.style.display = 'none';
            }
        }
        
        async function playOnlineSong(index) {
            state.isOnlineMode = true;
            state.currentTrackIndex = index;
            updatePlaylistHighlight();
            resetLyrics();

            const song = state.onlineSongs[index];
            dom.lyrics.innerHTML = `<div class="lyrics-line">æ­£åœ¨åŠ è½½: ${song.name}</div>`;
            
            const urlEndpoint = API.getSongUrl(song);
            const urlData = await fetch(urlEndpoint).then(res => res.json());

            const audioUrl = urlData.url?.replace(/^http:/, 'https');
            if (!audioUrl) throw new Error('æ— æ•ˆçš„æ’­æ”¾åœ°å€');

            dom.audioPlayer.src = audioUrl;
            dom.audioPlayer.load();
            dom.audioPlayer.play();

            // è·å–æ­Œè¯
            try {
                const lyricEndpoint = API.getLyric(song);
                const lyricData = await fetch(lyricEndpoint).then(res => res.json());

                if (lyricData.lyric) {
                    displayLyrics(lyricData.lyric);
                } else {
                    dom.lyrics.innerHTML = '<div class="lyrics-line">æœªæ‰¾åˆ°åœ¨çº¿æ­Œè¯</div>';
                }
            } catch (lyricError) {
                dom.lyrics.innerHTML = '<div class="lyrics-line">æ­Œè¯åŠ è½½å¤±è´¥</div>';
            }
        }

        function renderOnlinePlaylist() {
            dom.playlist.innerHTML = state.onlineSongs.map((s, i) =>
                `<div class="playlist-item" onclick="findAndPlayOnlineSong(${i})">
                    <i class="fas fa-music" style="margin-right: 10px; color: var(--neon-primary);"></i>
                    ${s.name} - ${s.artists.map(a => a.name).join('/')}
                </div>`
            ).join('') || "<div style='text-align: center; opacity: 0.6;'>åˆ—è¡¨ä¸ºç©º</div>";
        }

        function switchMobileView(view) {
            if (window.innerWidth > 768) return;
            if (view === 'playlist') {
                dom.showPlaylistBtn.classList.add('active');
                dom.showLyricsBtn.classList.remove('active');
                document.querySelector('.playlist-card').classList.remove('mobile-hidden');
                document.querySelector('.lyrics-card').classList.add('mobile-hidden');
            } else {
                dom.showPlaylistBtn.classList.remove('active');
                dom.showLyricsBtn.classList.add('active');
                document.querySelector('.playlist-card').classList.add('mobile-hidden');
                document.querySelector('.lyrics-card').classList.remove('mobile-hidden');
            }
        }
        
        function playPrevious() {
            if (state.currentTrackIndex <= 0) return;
            const newIndex = state.currentTrackIndex - 1;
            state.isOnlineMode ? findAndPlayOnlineSong(newIndex) : playAudio(newIndex);
        }

        function playNext() {
            const limit = state.isOnlineMode ? state.onlineSongs.length : state.audioFiles.length;
            if (state.currentTrackIndex >= limit - 1) {
                dom.lyrics.innerHTML = '<div class="lyrics-line">å·²æ˜¯åˆ—è¡¨æœ€åä¸€é¦–</div>';
                return;
            }
            const newIndex = state.currentTrackIndex + 1;
            state.isOnlineMode ? findAndPlayOnlineSong(newIndex) : playAudio(newIndex);
        }
        
        function autoPlayNext() { playNext(); }
        
        function processFiles(files) {
            if (files.length === 0) return;
            state.isOnlineMode = false;
            if (window.innerWidth <= 768) switchMobileView('playlist');
            let newFilesAdded = false;
            for (const file of files) {
                const ext = file.name.split('.').pop().toLowerCase();
                const baseName = file.name.split('.').slice(0, -1).join('.');
                if (['mp3', 'wav', 'ogg', 'm4a', 'flac', 'aac', 'wma'].includes(ext)) {
                    if (!state.audioFiles.some(f => f.name === file.name)) {
                        state.audioFiles.push(file);
                        newFilesAdded = true;
                    }
                } else if (['lrc', 'txt'].includes(ext)) {
                    state.lyricsFiles[baseName] = file;
                }
            }
            if (newFilesAdded) renderLocalPlaylist();
            if (state.audioFiles.length > 0 && dom.audioPlayer.paused) playAudio(0);
        }

        function playAudio(index) {
            if (index < 0 || index >= state.audioFiles.length) return;
            if (state.currentAudioUrl) URL.revokeObjectURL(state.currentAudioUrl);
            
            state.isOnlineMode = false;
            state.currentTrackIndex = index;
            updatePlaylistHighlight();
            
            const audioFile = state.audioFiles[index];
            state.currentAudioUrl = URL.createObjectURL(audioFile);
            dom.audioPlayer.src = state.currentAudioUrl;
            dom.audioPlayer.load();
            dom.audioPlayer.play();
            
            resetLyrics();
            loadLyricsForFile(audioFile);
        }

        async function findAndPlayOnlineSong(startIndex) {
            for (let i = startIndex; i < state.onlineSongs.length; i++) {
                try {
                    await playOnlineSong(i);
                    return;
                } catch (error) {
                    console.warn(`ç¬¬ ${i + 1} é¦– (${state.onlineSongs[i].name}) å°è¯•å¤±è´¥ï¼Œè·³è¿‡...`, error.message);
                }
            }
            dom.lyrics.innerHTML = '<div class="lyrics-line">æŠ±æ­‰ï¼Œå½“å‰åˆ—è¡¨ä¸­çš„æ­Œæ›²å‡æ— æ³•æ’­æ”¾</div>';
        }

        function renderLocalPlaylist() {
            dom.playlist.innerHTML = state.audioFiles.map((f, i) => 
                `<div class="playlist-item" onclick="playAudio(${i})">
                    <i class="fas fa-file-audio" style="margin-right: 10px; color: var(--neon-secondary);"></i>
                    ${f.name}
                </div>`
            ).join('') || "<div style='text-align: center; opacity: 0.6;'>è¯·é€‰æ‹©æœ¬åœ°éŸ³ä¹</div>";
        }

        function updatePlaylistHighlight() {
            const items = dom.playlist.querySelectorAll('.playlist-item');
            let currentItem = null;
            items.forEach((item, index) => {
                const isCurrent = index === state.currentTrackIndex;
                item.classList.toggle('current', isCurrent);
                if (isCurrent) currentItem = item;
            });
            if (currentItem) {
                currentItem.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
            }
        }

        function resetLyrics() {
            state.lyricsData = [];
            state.currentLyricLine = -1;
            dom.lyrics.innerHTML = '<div class="lyrics-line">...</div>';
        }

        async function loadLyricsForFile(audioFile) {
            const baseName = audioFile.name.split('.').slice(0, -1).join('.');
            const lyricsFile = state.lyricsFiles[baseName];
            if (lyricsFile) {
                const reader = new FileReader();
                reader.onload = (e) => displayLyrics(e.target.result);
                reader.readAsText(lyricsFile);
            } else {
                readEmbeddedLyrics(audioFile);
            }
        }
        
        function readEmbeddedLyrics(file) {
            jsmediatags.read(file, {
                onSuccess: (tag) => {
                    const lyricsText = tag.tags.USLT?.data ?? tag.tags.SYLT?.data ?? tag.tags.lyrics;
                    if (lyricsText) {
                        displayLyrics(lyricsText);
                    } else {
                        dom.lyrics.innerHTML = '<div class="lyrics-line">æœªæ‰¾åˆ°ä»»ä½•æ­Œè¯</div>';
                    }
                },
                onError: () => {
                    dom.lyrics.innerHTML = '<div class="lyrics-line">è¯»å–å†…åµŒæ­Œè¯å¤±è´¥</div>';
                }
            });
        }

        function parseLrc(text) {
            if (!text) return [];
            const lines = text.split('\n');
            const result = [];
            const timeRegex = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g;
            for (const line of lines) {
                const textContent = line.replace(timeRegex, '').trim();
                if (textContent) {
                    let match;
                    timeRegex.lastIndex = 0; 
                    while ((match = timeRegex.exec(line)) !== null) {
                        const minutes = parseInt(match[1], 10);
                        const seconds = parseInt(match[2], 10);
                        const milliseconds = parseInt(match[3].padEnd(3, '0'), 10);
                        result.push({
                            time: minutes * 60 + seconds + milliseconds / 1000,
                            text: textContent
                        });
                    }
                }
            }
            return result.sort((a, b) => a.time - b.time);
        }

        function displayLyrics(lrcText) {
            state.lyricsData = parseLrc(lrcText);
            if (state.lyricsData.length > 0) {
                dom.lyrics.innerHTML = state.lyricsData.map((item, index) => 
                    `<div class="lyrics-line" id="lyric-line-${index}">${item.text}</div>`
                ).join('');
            } else {
                dom.lyrics.innerHTML = lrcText.split('\n').map(line => 
                    `<div class="lyrics-line">${line || '&nbsp;'}</div>`
                ).join('');
            }
            state.currentLyricLine = -1;
            syncLyrics();
        }

        function syncLyrics() {
            if (state.lyricsData.length === 0 || dom.audioPlayer.paused) return;
            const currentTime = dom.audioPlayer.currentTime;
            let newIndex = state.lyricsData.findIndex((line, i) => {
                const nextLine = state.lyricsData[i + 1];
                return currentTime >= line.time && (nextLine ? currentTime < nextLine.time : true);
            });
            if (newIndex !== -1 && newIndex !== state.currentLyricLine) {
                const prevLine = document.getElementById(`lyric-line-${state.currentLyricLine}`);
                if (prevLine) prevLine.classList.remove('current');
                const currentLine = document.getElementById(`lyric-line-${newIndex}`);
                if (currentLine) {
                    currentLine.classList.add('current');
                    const lyricsCard = document.querySelector('.lyrics-card');
                    if (lyricsCard && !lyricsCard.classList.contains('mobile-hidden')) {
                        currentLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                state.currentLyricLine = newIndex;
            }
        }

        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }
    </script>
</body>
</html>
